# 4. Add apply() result state to ChangeOp

Date: 2019-06-21

## Status

Proposed

## Context

`wbeditentity` summary message for Wikibase Items and Properties provides
very little information on what have been changed on the entity, with the main
message in the summary being "Item Changed".

In T220696[1], we want to update those summary
messages generated for Wikibase Items and Properties when using `wbeditentity`
to be more detailed and informative.

Wikibase Lexeme achieved generating detailed summary messages by:

1. making its ChangeOp implementations update the summary object passed to
   the change op instance with granular information about the change.

2. implementing Wikibase\Lexeme\MediaWiki\Api\Summary\SummaryAggregator class
   and using it internally in some ChangeOp implementations (some of those that
   are non-leaf nodes and contain further change ops) in order to combine those
   summary messages generated by leaf nodes (the effective change ops in the
   tree).

## Considered actions

### I. Reusing current behavior

We considered doing the same thing for Wikibase, but that seemed a little off
with regards to clean design.

The main two places where this off-feeling came from are:

1. a tree hierarchy is often implemented for structural purposes, and then
   accessed through visitors for logic (implementing the Visitor pattern[2].

2. currently ChangeOp is concerned with:

	a. representing a change that can be applied to an entity

	b. applying that change to an entity

	c. generating summary messages as a result of applying it to an entity

### II. Cleaning into visitor pattern design

We then considered:

1. using Visitor Pattern[2] to implement our detailed summary generation
   for Wikibase Items and Properties;

2. changing ChangeOp design in a way that:

	a. allows a visitor class to operate over change ops hierarchy and attain
		the information it needs from it to complete its job. These information
		include whether the change op has been applied or discarded (no-op).

	b. is not a breaking change (WikibaseLexeme should continue to operate with
		no touch to it).

	c. does not extract the logic of applying a change op to an entity outside
		of it (remember logic can be implemented as a visitor) as it is out
		of scope and it isn't clear whether it will have enough justification.

The second consideration comes with some cost of initial implementation and
refactoring of current ChangeOp design and relevant implementations within
Wikibase.

The benefits of the second consideration is that it:

1. uses a more standard pattern with tree structures.

2. extracts the concern of summary messages generation out of
   ChangeOp, simplifying its design and implementations and scoping down
   the domain and dependencies of ChangeOp.

## Decision

TBD

## Consequences

The potential consequences of going with II (visitor pattern design) are:

1. [short-term] Wikibase and WikibaseLexeme will have two separate ways to
   achieve similar requirements.

   This can be mitigated by a follow-up refactoring task that changes
   Lexeme implementation into reusing the visitor pattern.


[1] https://phabricator.wikimedia.org/T220696

[2] Visitor Pattern https://en.wikipedia.org/wiki/Visitor_pattern
